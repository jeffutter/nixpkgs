---
id: hm-i416
status: closed
deps: []
links: []
created: 2026-02-15T01:37:18Z
type: task
priority: 1
assignee: Jeffery Utter
tags: [planned]
---
# Split zenbook home.nix into separate modules

The hosts/zenbook/home.nix file is 763 lines and contains mixed concerns: Hyprland config, Sway config, Waybar settings, idle management, and GUI app configurations.

Proposed split structure:
- gui/hyprland.nix - Hyprland window manager configuration
- gui/sway.nix - Sway window manager configuration  
- gui/waybar.nix - Waybar status bar settings
- gui/idle.nix - Swayidle auto-lock/suspend configuration
- gui/apps.nix - Electron app wrappers and GUI package definitions

This improves maintainability and makes it easier to reuse configurations across hosts.

## Design

### Approach
Pure refactoring — move sections of home.nix into new files under `hosts/zenbook/gui/`, then import them. No behavior changes. Ship as a single atomic commit.

### New Files and Content Mapping

**`hosts/zenbook/gui/hyprland.nix`** (lines 302-468)
- Function signature: `{ pkgs, lib, inputs, ... }:`
- Local `let` block: derive `iab` from `inputs.iio-ambient-brightness`
- Contains: `wayland.windowManager.hyprland` — animations, monitor, exec, env, bindings, input, gestures, workspaces, windowrulev2, misc

**`hosts/zenbook/gui/sway.nix`** (lines 253-300 + 470-661)
- Function signature: `{ pkgs, lib, config, inputs, ... }:`
- Local `let` block: derive `iab` and `my_bemoji` (bemoji is Sway-specific since it uses wtype)
- Contains: `wayland.windowManager.sway` — full sway config
- Contains: `programs.i3status-rust` — status bar used only by Sway
- Move `my_bemoji` out of `home.packages` and into this file's packages list (or just keep the let binding local)

**`hosts/zenbook/gui/waybar.nix`** (lines 104-206)
- Function signature: `{ pkgs, ... }:`
- Contains: `programs.waybar` — modules, bar config, Hyprland workspace widget

**`hosts/zenbook/gui/idle.nix`** (lines 664-691)
- Function signature: `{ pkgs, inputs, ... }:`
- Local `let` block: derive `iab`
- Contains: `services.swayidle` — lock events, timeouts, display power

**`hosts/zenbook/gui/apps.nix`** (lines 62-85 GUI packages + 208-251 lock screens + 693-758 desktop theming)
- Function signature: `{ pkgs, inputs, config, ... }:`
- Local `let` block: derive `my_zoom`, `my_todoist`, `zenbrowser` (GUI-specific wrappers)
- Contains: `home.packages` (GUI packages only — 1password, blueberry, discord, mako, obsidian, pavucontrol, slurp, telegram, wayshot, wl-clipboard, wlsunset, wluma, wofi, plus the let-derived wrappers)
- Contains: `programs.hyprlock` + `home.file."wallpapers/hyprlock.jpg"` (lock screen config)
- Contains: `programs.swaylock` (lock screen config)
- Contains: `fonts.fontconfig.enable`, `dconf.settings`, `gtk`, `xdg.configFile."wluma/config.toml"`, `home.file."bin/sunset"`, `home.file."bin/discord"`, `home.file."bin/obsidian"`, `home.sessionVariables`

### What Remains in home.nix

After the split, `home.nix` becomes a thin orchestrator (~40 lines):
- `imports` list: language modules + `./gui/hyprland.nix`, `./gui/sway.nix`, `./gui/waybar.nix`, `./gui/idle.nix`, `./gui/apps.nix`
- `stylix.override` (OLED black background)
- `programs.claude-code.settings.model`
- `programs.ghostty.enable`
- `home.file.".ssh/allowed_signers"`
- `programs.git.settings`
- `programs.ssh.extraOptionOverrides.identityFile`
- `home.username` / `home.homeDirectory`

### Shared Bindings Strategy

The `let` bindings (`iab`, `my_zoom`, `my_bemoji`, `my_todoist`, `zenbrowser`) are NOT shared via a common module. Instead, each new file re-derives only the bindings it needs in its own `let` block. This is idiomatic Nix — pure expressions produce identical results and avoid coupling between modules.

| Binding | File(s) |
|---|---|
| `iab` | hyprland.nix, sway.nix, idle.nix |
| `my_bemoji` | sway.nix only |
| `my_zoom` | apps.nix only |
| `my_todoist` | apps.nix only |
| `zenbrowser` | apps.nix only |

### Cross-Module References (via `config`)

These work transparently across module boundaries thanks to home-manager's lazy module system:
- Sway startup references `config.home.file."bin/sunset".target` — works even if `bin/sunset` is defined in apps.nix
- Sway keybindings use `with config.wayland.windowManager.sway.config` — self-referential, stays in sway.nix

### Verification

1. Create `hosts/zenbook/gui/` directory
2. Create all 5 module files
3. Update `home.nix` imports and remove moved code
4. Run `nix flake check` to verify
5. Optionally `~/bin/rebuild` on the zenbook to confirm runtime behavior

### Risks

- **`iab` duplication**: Repeating the derivation in 3 files is a minor code smell, but preferable to introducing a shared bindings module for 1 binding. If it bothers us later, we can extract it.
- **Package list split**: Must ensure no packages are lost or duplicated when splitting `home.packages` between apps.nix and home.nix. Do a diff to confirm.

## Acceptance Criteria

- Create separate module files under hosts/zenbook/
- Refactor home.nix to import these modules
- Verify build succeeds with nix flake check
- All functionality preserved

